# Policies
Default controller using [Authentication](../src/Default/Middleware/AuthorizeAction.php) middleware that's authorizes API requests using [Laravel Authorization](https://laravel.com/docs/authorization).

You can use `make:policy` Artisan command to generate a new policy class.

```shell
php artisan make:policy UserPolicy --model=Entities\\User
```

## Resource access
| Method | Route               | Ability |
|--------|---------------------|---------|
| GET    | /{resourceKey}      | viewAny |
| POST   | /{resourceKey}      | create  |
| GET    | /{resourceKey}/{id} | view    |
| PATCH  | /{resourceKey}/{id} | update  |
| DELETE | /{resourceKey}/{id} | delete  |

Authorized user must have access to ability depend on API request type.

For example if only authenticated user can view, update and delete itself, UserPolicy must be updated this way:
```php
public function view(User $user, User $model): bool
{
    return $user === $model;
}

public function update(User $user, User $model): bool
{
    return $user === $model;
}

public function delete(User $user, User $model): bool
{
    return $user === $model;
}
```

Create and list resource not going to have 2nd parameter as we don't have specific entity object to be authorized.

Another example allows view any user (list action) and create users only to admin accounts.
```php
public function viewAny(User $user): bool
{
    return $user->isAdmin();
}

public function create(User $user): bool
{
    return $user->isAdmin();
}
```

Use this table to understand which ability must be granted per each API action.

## Relationships access
Relationship routes abilities generated by the action and relationship name appended to it.

### To-One relationships
| Method | Route                                            | Ability              |
|--------|--------------------------------------------------|----------------------|
| GET    | /{resourceKey}/{id}/{relationship}               | view{Relationship}   |
| GET    | /{resourceKey}/{id}/relationships/{relationship} | view{Relationship}   |
| PATCH  | /{resourceKey}/{id}/relationships/{relationship} | update{Relationship} |

For example if we have "role" relationship in the user resource and only admin can change it and any other user can see it.
```php
// Any one can see role
public function viewRole(User $user): bool
{
    return true;
}

// Only admin can update user role
public function updateRole(User $user): bool
{
    return $user->isAdmin();
}
```

### To-Many relationships
| Method | Route                                            | Ability               |
|--------|--------------------------------------------------|-----------------------|
| GET    | /{resourceKey}/{id}/{relationship}               | viewAny{Relationship} |
| GET    | /{resourceKey}/{id}/relationships/{relationship} | viewAny{Relationship} |
| PATCH  | /{resourceKey}/{id}/relationships/{relationship} | update{Relationship}  |
| POST   | /{resourceKey}/{id}/relationships/{relationship} | create{Relationship}  |
| DELETE | /{resourceKey}/{id}/relationships/{relationship} | delete{Relationship}  |

In case multiple "roles" can be assigned to the user in your application, the policy definition going to look different.

```php
// Anyone can see user roles
public function viewAnyRoles(User $user): bool
{
    return true;
}

// Replace user roles
public function updateRoles(User $user): bool
{
    return $user->isAdmin();
}

// Append new roles to user
public function createRoles(User $user): bool
{
    return $user->isAdmin();
}

// Remove assigned roles
public function deleteRoles(User $user): bool
{
    return $user->isAdmin();
}
```
